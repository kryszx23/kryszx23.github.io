<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CompuInnova — Control de Reparaciones</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Sistema simple de control de reparaciones para CompuInnova: registro, seguimiento, etiquetas con código de barras e historial." />
  <style>
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }
    /* Etiqueta tamaño aproximado 62x30mm (se adapta al papel) */
    .label {
      width: 260px;
      min-height: 120px;
      border: 1px dashed #000;
      padding: 10px;
      border-radius: 10px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 6px;
      font-size: 12px;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-2xl font-bold tracking-tight">Compu<span class="text-indigo-600">Innova</span> — Control de Reparaciones</h1>
      <div class="flex gap-2">
        <button id="tab-create" class="px-3 py-2 rounded-2xl bg-indigo-600 text-white shadow hover:bg-indigo-700">Nueva orden</button>
        <button id="tab-list" class="px-3 py-2 rounded-2xl bg-slate-200 hover:bg-slate-300">Listado</button>
        <button id="tab-scan" class="px-3 py-2 rounded-2xl bg-slate-200 hover:bg-slate-300">Escanear</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">
    <!-- SECCIÓN CREAR ORDEN -->
    <section id="sect-create" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 bg-white rounded-2xl shadow p-4">
        <h2 class="text-xl font-semibold mb-4">Registrar nueva orden</h2>
        <form id="order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium">Cliente</label>
            <input required id="cliente" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="Nombre del cliente" />
          </div>
          <div>
            <label class="block text-sm font-medium">Teléfono</label>
            <input required id="telefono" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="300 123 4567" />
          </div>
          <div>
            <label class="block text-sm font-medium">Equipo</label>
            <select id="equipo" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500">
              <option>Celular</option>
              <option>Computador</option>
              <option>Tablet</option>
              <option>Otro</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium">Marca</label>
            <input id="marca" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="Samsung, Apple, HP…" />
          </div>
          <div>
            <label class="block text-sm font-medium">Modelo</label>
            <input id="modelo" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="A52, ProBook…" />
          </div>
          <div>
            <label class="block text-sm font-medium">IMEI / Serie</label>
            <input id="imei" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="Opcional" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium">Problema reportado</label>
            <textarea required id="problema" rows="3" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="No enciende, pantalla rota, sin audio…"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium">Accesorios</label>
            <input id="accesorios" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="Cargador, SIM, memoria…" />
          </div>
          <div>
            <label class="block text-sm font-medium">Patrón/Clave</label>
            <input id="clave" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="Si aplica" />
          </div>
          <div>
            <label class="block text-sm font-medium">Costo estimado</label>
            <input id="costo" type="number" min="0" step="1000" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500" placeholder="0" />
          </div>
          <div>
            <label class="block text-sm font-medium">Estado</label>
            <select id="estado" class="w-full mt-1 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-500">
              <option>Ingresado</option>
              <option>En diagnóstico</option>
              <option>En reparación</option>
              <option>Listo para entrega</option>
              <option>Entregado</option>
              <option>No reparado</option>
            </select>
          </div>
          <div class="md:col-span-2 flex items-center justify-end gap-2 mt-2">
            <button type="reset" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">Limpiar</button>
            <button type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white shadow hover:bg-indigo-700">Guardar orden</button>
          </div>
        </form>
      </div>

      <aside class="bg-white rounded-2xl shadow p-4">
        <h3 class="font-semibold mb-2">Acciones</h3>
        <div class="space-y-2">
          <button id="btn-export" class="w-full px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Exportar respaldo (.json)</button>
          <label class="block w-full">
            <span class="block mb-1 text-sm">Importar respaldo (.json)</span>
            <input id="import-file" type="file" accept="application/json" class="w-full" />
          </label>
          <button id="btn-clear" class="w-full px-3 py-2 rounded-xl bg-red-50 text-red-700 hover:bg-red-100">Vaciar base local</button>
          <p class="text-xs text-slate-500">Los datos se guardan en este navegador con <strong>localStorage</strong>. Opcionalmente se puede conectar a Firebase más adelante.</p>
        </div>
      </aside>
    </section>

    <!-- SECCIÓN LISTADO -->
    <section id="sect-list" class="hidden">
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
          <h2 class="text-xl font-semibold">Órdenes registradas</h2>
          <div class="flex gap-2 items-center">
            <input id="search" class="rounded-xl border-slate-300" placeholder="Buscar por ID, cliente, teléfono, IMEI…" />
            <select id="filter-status" class="rounded-xl border-slate-300">
              <option value="">Todos</option>
              <option>Ingresado</option>
              <option>En diagnóstico</option>
              <option>En reparación</option>
              <option>Listo para entrega</option>
              <option>Entregado</option>
              <option>No reparado</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100">
              <tr>
                <th class="p-2 text-left">ID</th>
                <th class="p-2 text-left">Fecha</th>
                <th class="p-2 text-left">Cliente</th>
                <th class="p-2 text-left">Equipo</th>
                <th class="p-2 text-left">Marca/Modelo</th>
                <th class="p-2 text-left">Estado</th>
                <th class="p-2 text-left">Acciones</th>
              </tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SECCIÓN ESCANEAR -->
    <section id="sect-scan" class="hidden">
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Escanear código de barras</h2>
          <div class="flex gap-2">
            <button id="btn-start-scan" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Iniciar cámara</button>
            <button id="btn-stop-scan" class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">Detener</button>
          </div>
        </div>
        <div id="scanner" class="w-full max-w-xl aspect-video bg-slate-100 rounded-xl grid place-items-center text-slate-500">
          <span>La previsualización aparecerá aquí…</span>
        </div>
        <div id="scan-result" class="mt-4 hidden bg-slate-50 border rounded-xl p-3"></div>
      </div>
    </section>
  </main>

  <!-- MODAL DETALLES -->
  <dialog id="dlg-detail" class="rounded-2xl p-0 w-full max-w-2xl">
    <div class="p-4 border-b flex items-center justify-between">
      <h3 class="text-lg font-semibold">Detalle de la orden</h3>
      <button class="px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300" onclick="closeDetail()">Cerrar</button>
    </div>
    <div id="detail-body" class="p-4 text-sm"></div>
  </dialog>

  <!-- MODAL IMPRIMIR ETIQUETA -->
  <dialog id="dlg-print" class="rounded-2xl p-0 w-full max-w-lg">
    <div class="p-4 border-b flex items-center justify-between">
      <h3 class="text-lg font-semibold">Imprimir etiqueta</h3>
      <div class="flex items-center gap-2">
        <label class="text-sm">Copias:
          <input id="copies" type="number" min="1" value="1" class="w-16 ml-1 rounded-lg border-slate-300" />
        </label>
        <button class="px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300" onclick="closePrint()">Cerrar</button>
      </div>
    </div>
    <div class="p-4">
      <div id="print-area" class="grid gap-3"></div>
      <div class="mt-4 flex justify-end">
        <button class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700" onclick="window.print()">Imprimir</button>
      </div>
    </div>
  </dialog>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" integrity="sha512-Ja2nQ7ggJmJvQn6d1bZQWw5J6e9C4nLh8I5V5d3m7C2o4xw0y8G2Gv2zT4X6tqkq3mHwB7a2b1u2b3gKk5v7jg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    const KEY = 'compuinnova_tickets_v1';

    const $ = (id) => document.getElementById(id);

    const state = {
      tickets: [],
      scannerRunning: false,
      currentPrintId: null,
    };

    function uid() {
      const t = Date.now().toString(36).toUpperCase();
      const r = Math.random().toString(36).slice(2, 6).toUpperCase();
      return `CPI-${t}-${r}`;
    }

    function load() {
      try { state.tickets = JSON.parse(localStorage.getItem(KEY)) || []; }
      catch { state.tickets = []; }
      renderTable();
    }

    function persist() {
      localStorage.setItem(KEY, JSON.stringify(state.tickets));
    }

    function formatDate(ts) {
      const d = new Date(ts);
      return d.toLocaleString();
    }

    function addTicket(e) {
      e.preventDefault();
      const data = {
        id: uid(),
        createdAt: Date.now(),
        cliente: $('cliente').value.trim(),
        telefono: $('telefono').value.trim(),
        equipo: $('equipo').value,
        marca: $('marca').value.trim(),
        modelo: $('modelo').value.trim(),
        imei: $('imei').value.trim(),
        problema: $('problema').value.trim(),
        accesorios: $('accesorios').value.trim(),
        clave: $('clave').value.trim(),
        costo: Number($('costo').value || 0),
        estado: $('estado').value,
        notas: [],
        historial: [ { ts: Date.now(), evento: 'Creación de la orden' } ],
      };
      state.tickets.unshift(data);
      persist();
      e.target.reset();
      alert(`Orden creada: ${data.id}`);
      renderTable();
      // Cambiar a listado
      showTab('list');
    }

    function renderTable() {
      const tbody = $('table-body');
      if (!tbody) return;
      const q = ($('search')?.value || '').toLowerCase();
      const fs = $('filter-status')?.value || '';
      const rows = state.tickets.filter(t => {
        const matchQ = !q || [t.id, t.cliente, t.telefono, t.imei, t.marca, t.modelo, t.problema].join(' ').toLowerCase().includes(q);
        const matchS = !fs || t.estado === fs;
        return matchQ && matchS;
      }).map(t => {
        return `<tr class="border-b hover:bg-slate-50">
          <td class="p-2 font-mono text-xs">${t.id}</td>
          <td class="p-2">${formatDate(t.createdAt)}</td>
          <td class="p-2">${t.cliente}<div class="text-xs text-slate-500">${t.telefono}</div></td>
          <td class="p-2">${t.equipo}</td>
          <td class="p-2">${t.marca || ''} ${t.modelo || ''}</td>
          <td class="p-2">
            <select class="rounded-lg border-slate-300 text-xs" onchange="updateStatus('${t.id}', this.value)">
              ${['Ingresado','En diagnóstico','En reparación','Listo para entrega','Entregado','No reparado'].map(s => `<option ${t.estado===s?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td class="p-2">
            <div class="flex gap-2">
              <button class="px-2 py-1 rounded-lg bg-slate-200 hover:bg-slate-300 text-xs" onclick="openDetail('${t.id}')">Ver</button>
              <button class="px-2 py-1 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-xs" onclick="openPrint('${t.id}')">Etiqueta</button>
              <button class="px-2 py-1 rounded-lg bg-red-50 text-red-700 hover:bg-red-100 text-xs" onclick="delTicket('${t.id}')">Eliminar</button>
            </div>
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows || `<tr><td class="p-3 text-center text-slate-500" colspan="7">Sin registros…</td></tr>`;
    }

    function updateStatus(id, value) {
      const t = state.tickets.find(x => x.id === id);
      if (!t) return;
      if (t.estado !== value) {
        t.estado = value;
        t.historial.push({ ts: Date.now(), evento: `Cambio de estado a: ${value}` });
        persist();
      }
    }

    function delTicket(id) {
      if (!confirm('¿Eliminar definitivamente esta orden?')) return;
      state.tickets = state.tickets.filter(t => t.id !== id);
      persist();
      renderTable();
    }

    function openDetail(id) {
      const t = state.tickets.find(x => x.id === id);
      if (!t) return;
      const html = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <div class="text-xs text-slate-500">ID</div>
            <div class="font-mono">${t.id}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Fecha</div>
            <div>${formatDate(t.createdAt)}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Cliente</div>
            <div>${t.cliente} — ${t.telefono}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Equipo</div>
            <div>${t.equipo} ${t.marca ? '• '+t.marca : ''} ${t.modelo ? '• '+t.modelo : ''}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">IMEI/Serie</div>
            <div>${t.imei || '-'}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Costo estimado</div>
            <div>$ ${t.costo.toLocaleString()}</div>
          </div>
          <div class="md:col-span-2">
            <div class="text-xs text-slate-500">Problema reportado</div>
            <div>${t.problema}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Accesorios</div>
            <div>${t.accesorios || '-'}</div>
          </div>
          <div>
            <div class="text-xs text-slate-500">Clave/Patrón</div>
            <div>${t.clave || '-'}</div>
          </div>
          <div class="md:col-span-2">
            <div class="text-xs text-slate-500 mb-1">Historial</div>
            <ul class="list-disc pl-5 space-y-1">${t.historial.map(h => `<li>${formatDate(h.ts)} — ${h.evento}</li>`).join('')}</ul>
          </div>
        </div>`;
      $('detail-body').innerHTML = html;
      $('dlg-detail').showModal();
    }

    function closeDetail(){ $('dlg-detail').close(); }

    function openPrint(id) {
      state.currentPrintId = id;
      const t = state.tickets.find(x => x.id === id);
      if (!t) return;
      const area = $('print-area');
      area.innerHTML = '';
      const copies = Number($('copies').value || 1);
      for (let i=0;i<copies;i++) {
        const card = document.createElement('div');
        card.className = 'label bg-white';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold">Compu<span class="text-indigo-600">Innova</span></div>
            <div class="text-xs">${new Date().toLocaleDateString()}</div>
          </div>
          <div>
            <div class="text-xs">ID: <span class="font-mono">${t.id}</span></div>
            <div class="text-xs">Cliente: ${t.cliente}</div>
            <div class="text-xs">Equipo: ${t.equipo} ${t.marca? '• '+t.marca:''} ${t.modelo? '• '+t.modelo:''}</div>
            <div class="text-xs">Problema: ${t.problema.slice(0,60)}${t.problema.length>60?'…':''}</div>
          </div>
          <div class="grid place-items-center">
            <svg id="barcode-${i}"></svg>
          </div>`;
        area.appendChild(card);
        // Generar código de barras CODE128 del ID
        setTimeout(() => {
          try {
            JsBarcode(`#barcode-${i}`, t.id, { format: 'CODE128', displayValue: true, fontSize: 12, margin: 0, width: 1, height: 30 });
          } catch (err) { console.error(err); }
        }, 0);
      }
      $('dlg-print').showModal();
    }

    function closePrint(){ $('dlg-print').close(); }

    // Tabs
    function showTab(key){
      const map = { create: 'sect-create', list: 'sect-list', scan: 'sect-scan' };
      Object.values(map).forEach(id => $(id).classList.add('hidden'));
      $(map[key]).classList.remove('hidden');

      // Estilos de botones
      const btns = { create: 'tab-create', list: 'tab-list', scan: 'tab-scan' };
      Object.values(btns).forEach(id => {
        $(id).classList.remove('bg-indigo-600','text-white');
        $(id).classList.add('bg-slate-200');
      });
      $(btns[key]).classList.add('bg-indigo-600','text-white');
      $(btns[key]).classList.remove('bg-slate-200');

      // Control del escáner
      if (key !== 'scan') stopScanner();
    }

    // Escáner con Quagga (Code128)
    function startScanner(){
      if (state.scannerRunning) return;
      const el = $('scanner');
      el.innerHTML = '';
      el.classList.add('relative');
      const viewport = document.createElement('div');
      viewport.id = 'scanner-viewport';
      viewport.className = 'w-full h-full overflow-hidden rounded-xl';
      el.appendChild(viewport);

      Quagga.init({
        inputStream: {
          name: 'Live',
          type: 'LiveStream',
          target: viewport,
          constraints: { facingMode: 'environment' }
        },
        decoder: { readers: ['code_128_reader'] },
        locate: true
      }, (err) => {
        if (err) { alert('No se pudo iniciar la cámara: ' + err); return; }
        Quagga.start();
        state.scannerRunning = true;
      });

      Quagga.onDetected(onDetected);
    }

    function stopScanner(){
      if (!state.scannerRunning) return;
      try { Quagga.stop(); } catch {}
      state.scannerRunning = false;
      Quagga.offDetected(onDetected);
      $('scanner').innerHTML = '<span>La previsualización aparecerá aquí…</span>';
    }

    function onDetected(res){
      const code = res?.codeResult?.code;
      if (!code) return;
      // Evitar múltiples lecturas iguales
      Quagga.pause();
      const ticket = state.tickets.find(t => t.id === code);
      const box = $('scan-result');
      if (ticket) {
        box.classList.remove('hidden');
        box.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <div class="text-sm">Coincidencia encontrada:</div>
              <div class="text-lg font-semibold">${ticket.cliente} — <span class="font-mono text-sm">${ticket.id}</span></div>
              <div class="text-sm text-slate-600">${ticket.equipo} ${ticket.marca||''} ${ticket.modelo||''}</div>
              <div class="text-sm">Estado: <span class="font-medium">${ticket.estado}</span></div>
              <div class="text-sm">Problema: ${ticket.problema}</div>
            </div>
            <div class="flex gap-2">
              <button class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300" onclick="openDetail('${ticket.id}')">Ver</button>
              <button class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700" onclick="openPrint('${ticket.id}')">Etiqueta</button>
            </div>
          </div>`;
      } else {
        box.classList.remove('hidden');
        box.innerHTML = `<div class="text-red-600">No se encontró la orden con ID <span class="font-mono">${code}</span></div>`;
      }
      setTimeout(() => { try { Quagga.start(); } catch {} }, 800);
    }

    // Export/Import/Clear
    function exportJson(){
      const blob = new Blob([JSON.stringify(state.tickets, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `compuinnova-respaldo-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJson(file){
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const arr = JSON.parse(e.target.result);
          if (!Array.isArray(arr)) throw new Error('Formato inválido');
          state.tickets = arr;
          persist();
          renderTable();
          alert('Importación exitosa');
        } catch(err) { alert('Error importando: ' + err.message); }
      };
      reader.readAsText(file);
    }

    function clearAll(){
      if (!confirm('Esto borrará todos los datos guardados en este navegador. ¿Continuar?')) return;
      state.tickets = [];
      persist();
      renderTable();
    }

    // Eventos
    window.addEventListener('DOMContentLoaded', () => {
      load();
      $('order-form').addEventListener('submit', addTicket);
      $('search').addEventListener('input', renderTable);
      $('filter-status').addEventListener('change', renderTable);
      $('btn-export').addEventListener('click', exportJson);
      $('import-file').addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (f) importJson(f);
      });
      $('btn-clear').addEventListener('click', clearAll);
      $('tab-create').addEventListener('click', () => showTab('create'));
      $('tab-list').addEventListener('click', () => showTab('list'));
      $('tab-scan').addEventListener('click', () => showTab('scan'));
      $('btn-start-scan').addEventListener('click', startScanner);
      $('btn-stop-scan').addEventListener('click', stopScanner);
    });

    // Exponer funciones necesarias al scope global
    window.openDetail = openDetail;
    window.closeDetail = closeDetail;
    window.openPrint = openPrint;
    window.closePrint = closePrint;
    window.updateStatus = updateStatus;
    window.delTicket = delTicket;
    window.showTab = showTab;
    window.startScanner = startScanner;
    window.stopScanner = stopScanner;
  </script>
</body>
</html>
